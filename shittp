#!/bin/sh

set -eu

: ${SHITTP_CONFIG_DIR:="${XDG_CONFIG_HOME:-$HOME/.config}/shittp"}

cleanup() {
  [ "${tar_tmpdir:-}" ] && rm -rf "$tar_tmpdir"
}

trap cleanup EXIT

msg() {
  IFS=" $IFS"
  set -- '%s\n' "${*:-}"
  IFS=${IFS#?}
  printf "$@"
}

die() {
  [ "${1:-}" ] && msg "$1"
  exit "${2:-1}"
}

require() {
  while [ $# -gt 0 ]; do
    hash "$1" 2>/dev/null || {
      msg "Dependency [ $1 ] is required";
      failed=1
    }
    shift
  done
  [ "${failed:-}" ] && return 1 || return 0
}

usage() {
  cat <<'USAGE'
shittp - dotfiles carrier for SSH

Usage: shittp [options]... [command] [ssh_options]... destination

Options:
  -h, --help            You're looking at it
  --config-dir DIR      Specify shittp config directory [default: ~/.config/shittp]

Commands:
  where                 Show default shittp config directory
  print                 Print the command instead of run as SSH remote command
                        Useful when you want to run in different environment like Docker

Examples:
  shittp john@192.168.78.66  # SSH login to 192.168.78.66 with your dotfiles
  shittp where               # Prints shittp config directory (i.e. ~/.config/shittp)
  sudo docker run -it alpine /bin/sh -c "$(shittp print)"
                             # Start sh in alpine with your dotfiles
USAGE
exit 0
}

# Show help if didn't provide any arguments
[ $# -eq 0 ] && usage

print_only=0
arg_build_script='set -- '
while [ $# -gt 0 ]; do
  consumed=0
  case $1 in
    -h | --help)
      usage
    ;;
    where)
      echo "$SHITTP_CONFIG_DIR"
      exit 0
    ;;
    print)
      consumed=1
      print_only=1
      shift
    ;;
    --config-dir)
      consumed=1
      [ "${2:-}" ] || die "SHITTP_CONFIG_DIR of option [ $1 ] not specified"
      SHITTP_CONFIG_DIR=$(cd "$2" && pwd -P)
      shift # --config
      shift # SHITTP_CONFIG_DIR
    ;;
    -o)
      case $2 in 
        [Rr]emote[Cc]ommand=*)
          consumed=1
          extra_command=${2#[Rr]emote[Cc]ommand=}
          shift # -o
          shift # RemoteCommand=XXX
        ;;
      esac
    ;;
    -o[Rr]emote[Cc]ommand=*)
      consumed=1
      extra_command=${1#[Rr]emote[Cc]ommand=}
      shift # -oRemoteCommand=XXX
    ;;
    *)
    ;;
  esac
  if [ "$consumed" = 0 ]; then
    arg_build_script="$arg_build_script '$1'"
    shift
  fi
done
eval "$arg_build_script"

require mktemp tar base64

if [ ! -d "$SHITTP_CONFIG_DIR" ]; then
  die "Config [ $SHITTP_CONFIG_DIR ] is required"
fi

tar_tmpdir=$(mktemp --directory)
cp -r "$SHITTP_CONFIG_DIR" "$tar_tmpdir/shittp"

# Create the script with here-document so we don't need to figure out how to escape quotes
setup_script=$(cat <<'SETUP'
trap 'rm -rf "$SHITTP_HOME"' EXIT

export SHITTP="$SHITTP_HOME/shittp_init.sh"
echo "echo '[shittp] Inited'" >>"$SHITTP" # ensure exists

case $SHELL in
  *bash*)
    echo '. "$SHITTP"' >>"$SHITTP_HOME/.bashrc"
    bash --init-file "$SHITTP_HOME/.bashrc"
  ;;
  *zsh*)
    echo '. "$SHITTP"' >>"$SHITTP_HOME/.zshrc"
    export ZDOTDIR=$SHITTP_HOME
    zsh -i
  ;;
  *) 
    echo '[shittp] Run this to initialize:'
    echo '. "$SHITTP"'
    ${SHELL:-/bin/sh} -i
  ;;
esac
SETUP
)

archive_build_script=$(
  printf '%s\n' "archive="
  tar czf - -C "$tar_tmpdir/shittp" . |
    base64 |
    while IFS= read -r line; do
      printf 'archive="${archive}%s\\n"\n' "$line"
    done
)

remote_command="$archive_build_script"'
tmpdir=$(mktemp --directory)
printf "$archive" | base64 -d | tar zxf - -C "$tmpdir"
export SHITTP_HOME=$tmpdir
# shittp_setup
'"$setup_script"'
# extra command
'"${extra_command:-}"

if [ "$print_only" = 1 ]; then
  msg "$remote_command"
else
  ssh -t -o RemoteCommand="$remote_command" "$@"
fi

