#!/bin/sh
# vim: set expandtab tabstop=2 softtabstop=2 shiftwidth=2 :

set -eu

: "${SHITTP_CONFIG_DIR:="${XDG_CONFIG_HOME:-$HOME/.config}/shittp"}"
: "${SHITTP_SSH_CLIENT:=ssh}"

cleanup() {
  [ "${tar_tmpdir:-}" ] || return 0
  rm -r "$tar_tmpdir"
}

# Do not trap any signal when running shellspec test
[ "${__SOURCED__:-}" ] || trap cleanup EXIT

msg() {
  IFS=" $IFS"
  set -- '%s\n' "${*:-}"
  IFS=${IFS#?}
  # shellcheck disable=SC2059
  printf "$@"
}

die() {
  [ "${1:-}" ] && msg "$1"
  exit "${2:-1}"
}

# Genius quoting function by Koichi Nakashima
# Under License: Creative Commons Zero v1.0 Universal
# Source: https://github.com/ko1nksm/getoptions/blob/master/lib/getoptions_base.sh
quote() {
  q="$2'" r=""
  while [ "$q" ]; do r="$r${q%%\'*}'\''" && q=${q#*\'}; done
  q="'${r%????}'" && q=${q#\'\'} && q=${q%\'\'}
  eval "$1=\${q:-\"''\"}"
}

require() {
  _status=0
  while [ $# -gt 0 ]; do
    type "$1" >/dev/null 2>&1 || {
      msg "Dependency [ $1 ] is required";
      _status=1
    }
    shift
  done
  return "$_status"
}

usage() {
  >&2 cat <<'USAGE'
shittp - dotfiles carrier for SSH

Usage: shittp [options]... [command] [ssh_options]... destination [-- ssh_command]

Options:
  -h, --help            You're looking at it
  --config-dir DIR      Specify config directory [default: ~/.config/shittp]
  --client CLIENT       Specify SSH client command (e.g., dbclient)
                        [default: ssh]

Commands:
  where                 Show default shittp config directory
  print                 Print the command instead of run as SSH remote command
                        Useful for loading dotfiles in environment like Docker

Examples:
  shittp john@192.168.78.66  # SSH login to 192.168.78.66 with your dotfiles
  shittp john@example.com -- restart_tomcat
                             # Execute command with dotfiles defined function
  docker run -it alpine /bin/sh -c "$(shittp print)"
                             # Start sh in alpine with your dotfiles
  shittp where               # Prints config directory (i.e. ~/.config/shittp)
  shittp --client dbclient john@example.com
                             # Connect with Dropbear SSH client

Environment Variables:
  Annotation:
    [default: ?]        The variable have a default value
    @remote             The variable will populate on the remote

  SHITTP_CONFIG_DIR     Directory that your dotfiles live
                        [default: ~/.config/shittp]
  SHITTP_SHELL          Shell path you would like to use on the remote
                        @remote [default: your login shell such as /bin/sh ]
  SHITTP_SSH_CLIENT     SSH client path you want to use, will be override
                        by --client option
                        [default: ssh]
  SHITTP                Path to shittp_init.sh. Source it if didn't see
                        "[shittp] Inited" message after login
                        @remote
  SHITTP_HOME           Which directory you want to extract dotfiles tarball to
                        @remote [default: a temp directory]
  SHITTP_INITED         value is 1 if shittp initialized
                        @remote

USAGE
exit 0
}

cmd_where=0
cmd_print_only=0
set_args_stat='set --'
parse_args() {
  while [ $# -gt 0 ]; do
    _consumed=0
    case $1 in
      -h | --help)
        usage
      ;;
      where)
        cmd_where=1
        return
      ;;
      print)
        _consumed=1
        cmd_print_only=1
        shift
      ;;
      --config-dir)
        _consumed=1
        [ "${2:-}" ] || die "SHITTP_CONFIG_DIR of option [ $1 ] not specified"
        SHITTP_CONFIG_DIR=$(cd "$2" && pwd -P)
        shift # --config
        shift # SHITTP_CONFIG_DIR
      ;;
      --client)
        _consumed=1
        SHITTP_SSH_CLIENT=$2
        shift # --client
        shift # SHITTP_SSH_CLIENT
      ;;
      -o)
        case $2 in 
          [Rr]emote[Cc]ommand=*)
            _consumed=1
            extra_command=${2#[Rr]emote[Cc]ommand=}
            shift # -o
            shift # RemoteCommand=XXX
          ;;
        esac
      ;;
      -o[Rr]emote[Cc]ommand=*)
        _consumed=1
        extra_command=${1#-o[Rr]emote[Cc]ommand=}
        shift # -oRemoteCommand=XXX
      ;;
      --)
        shift # --
        IFS=" $IFS"
        extra_command="${*:-}"
        IFS=${IFS#?}
        break
      ;;
      *)
      ;;
    esac
    if [ "$_consumed" = 0 ]; then
      quote 'quoted' "$1"
      set_args_stat="$set_args_stat ${quoted:-}"
      shift
    fi
  done
}

dir_to_b64() {
  tar czf - -C "$1" . |
    base64 |
    while IFS= read -r line; do
      printf '%s' "$line"
    done
}

detect_ssh_client_type() {
  _client=$1
  case $("$_client" 2>&1 ||:) in
    *dropbear*) client_type=dbclient ;;
    *)          client_type=''       ;;
  esac
  case ${client_type:-$_client} in
    *ssh*)      printf 'openssh'  ;;
    *dbclient*) printf 'dropbear' ;;
    *)          printf 'unknown'  ;;
  esac
}

# Early return for shellspec testing
${__SOURCED__:+return}

# Show help if no arguments provided
[ $# -eq 0 ] && usage

parse_args "$@"
eval "$set_args_stat"

if [ "$cmd_where" = 1 ]; then
  echo "$SHITTP_CONFIG_DIR"
  exit 0
fi

require mktemp tar base64

if [ ! -d "$SHITTP_CONFIG_DIR" ]; then
  die "Config [ $SHITTP_CONFIG_DIR ] is required"
fi

tar_tmpdir=$(mktemp -d)
cp -r "$SHITTP_CONFIG_DIR" "$tar_tmpdir/shittp"

if [ "${extra_command:-}" ]; then
  printf '%s' "$extra_command; exit" >"$tar_tmpdir/shittp/_shittp_extra_command.sh"
fi

# shellcheck disable=SC2016
printf '%s' '
export SHITTP_INITED=1
if [ -r "$SHITTP_HOME/_shittp_extra_command.sh" ]; then
  . "$SHITTP_HOME/_shittp_extra_command.sh"
else
  echo "[shittp] Inited"
fi
' >>"$tar_tmpdir/shittp/shittp_init.sh" # ensure exists

# Create the script with here-document so we don't need to figure out how to escape quotes
setup_script=$(cat <<'SETUP'
trap 'rm -r "$SHITTP_HOME"' EXIT

export SHITTP="$SHITTP_HOME/shittp_init.sh"

case ${SHITTP_SHELL:-$SHELL} in
  *bash*)
    echo '[ "${SHITTP_INITED:-}" ] || . "$SHITTP"' >>"$SHITTP_HOME/.bashrc"
    bash --init-file "$SHITTP_HOME/.bashrc"
  ;;
  *zsh*)
    echo '[ "${SHITTP_INITED:-}" ] || . "$SHITTP"' >>"$SHITTP_HOME/.zshrc"
    export ZDOTDIR=$SHITTP_HOME
    zsh -i
  ;;
  *) 
    ENV=$SHITTP "${SHELL:-/bin/sh}" -i
  ;;
esac
SETUP
)

# shellcheck disable=SC2016
remote_command='SHITTP_HOME="'"${SHITTP_HOME:-}"'"
[ "${SHITTP_HOME:-}" ] || SHITTP_HOME=$(mktemp -d)
base64 -d <<EOF | tar zxf - -C "$SHITTP_HOME"
'"$(dir_to_b64 "$tar_tmpdir/shittp")"'
EOF
export SHITTP_HOME
'"export SHITTP_SHELL=${SHITTP_SHELL:-}"'
'"$setup_script"

if [ "$cmd_print_only" = 1 ]; then
  msg "$remote_command"
  exit 0
fi

case $(detect_ssh_client_type "$SHITTP_SSH_CLIENT") in
  openssh)
    "$SHITTP_SSH_CLIENT" -t -oRemoteCommand="$remote_command" "$@"
  ;;
  dropbear)
    "$SHITTP_SSH_CLIENT" -t "$@" "$remote_command"
  ;;
  unknown)
    die "Sorry, shittp doesn't support for SSH client [ $SHITTP_SSH_CLIENT ]"
  ;;
esac
